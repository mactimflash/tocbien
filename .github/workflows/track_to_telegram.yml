name: Track Page View

on:
  repository_dispatch:
    types: [page_view]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Debug payload
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "event_type=${{ github.event.action }}"
          echo "payload=${{ toJson(github.event.client_payload) }}"

      - name: Build Telegram message
        id: msg
        run: |
          TYPE="${{ github.event.client_payload.type }}"
          PATH="${{ github.event.client_payload.path }}"
          REF="${{ github.event.client_payload.ref }}"
          UA="${{ github.event.client_payload.ua }}"
          TS="${{ github.event.client_payload.ts }}"

          # Fallback
          [ -z "$TYPE" ] && TYPE="page_view"
          [ -z "$TS" ] && TS="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          TEXT="ðŸ‘€ Page view%0Aâ€¢ type: ${TYPE}%0Aâ€¢ path: ${PATH}%0Aâ€¢ ref: ${REF}%0Aâ€¢ ua: ${UA}%0Aâ€¢ time: ${TS}"

          echo "text=$TEXT" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TEXT: ${{ steps.msg.outputs.text }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID secrets"
            exit 1
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            --data "{\"chat_id\":\"${TELEGRAM_CHAT_ID}\",\"text\":\"${TEXT}\",\"disable_web_page_preview\":true}" \
            -o resp.json

          echo "Telegram response:"
          cat resp.json
