name: Track Page View -> Telegram

on:
  repository_dispatch:
    types: [page_view]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Print event json
        run: cat "$GITHUB_EVENT_PATH"

      - name: Install jq
        run: |
          command -v jq >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y jq)

      - name: Send Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          test -n "$BOT_TOKEN" || (echo "Missing TELEGRAM_BOT_TOKEN" && exit 1)
          test -n "$CHAT_ID" || (echo "Missing TELEGRAM_CHAT_ID" && exit 1)
          PATH_=$(jq -r '.client_payload.path // "unknown"' "$GITHUB_EVENT_PATH")
          REF_=$(jq -r '.client_payload.ref // ""' "$GITHUB_EVENT_PATH")
          UA_=$(jq -r '.client_payload.ua // ""' "$GITHUB_EVENT_PATH")
          TS_=$(jq -r '.client_payload.ts // ""' "$GITHUB_EVENT_PATH")
          COUNTRY_=$(jq -r '.client_payload.country // ""' "$GITHUB_EVENT_PATH")
          CITY_=$(jq -r '.client_payload.city // ""' "$GITHUB_EVENT_PATH")
          TEXT=$(printf "Visitor GitHub Pages\nPath: %s\nRef: %s\nGeo: %s %s\nUA: %s\nTime: %s\n" "$PATH_" "$REF_" "$CITY_" "$COUNTRY_" "$UA_" "$TS_")
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" -H "Content-Type: application/json" -d "$(jq -n --arg chat_id "$CHAT_ID" --arg text "$TEXT" '{chat_id:$chat_id, text:$text}')"
