name: Track Page View -> Telegram

on:
  repository_dispatch:
    types: [page_view]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Check payload
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Payload:"
          cat "$GITHUB_EVENT_PATH"

      - name: Send Telegram
        if: github.event_name == 'repository_dispatch'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |

          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Missing Telegram secrets"
            exit 1
          fi

          PAYLOAD=$(cat "$GITHUB_EVENT_PATH")

          PATH_=$(echo "$PAYLOAD" | jq -r '.client_payload.path // "unknown"')
          REF_=$(echo "$PAYLOAD" | jq -r '.client_payload.ref // ""')
          UA_=$(echo "$PAYLOAD" | jq -r '.client_payload.ua // ""')
          TS_=$(echo "$PAYLOAD" | jq -r '.client_payload.ts // ""')
          COUNTRY_=$(echo "$PAYLOAD" | jq -r '.client_payload.country // ""')
          CITY_=$(echo "$PAYLOAD" | jq -r '.client_payload.city // ""')

          MSG="ðŸ‘€ Visitor GitHub Pages
Path: $PATH_
Ref: $REF_
Geo: $CITY_ $COUNTRY_
UA: $UA_
Time: $TS_"

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg chat_id "$CHAT_ID" --arg text "$MSG" '{chat_id:$chat_id, text:$text}')"
